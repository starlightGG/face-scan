<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="favicon.svg" />
<link rel="shortcut icon" href="favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png" />
<meta name="apple-mobile-web-app-title" content="Face-Scan GG" />
<link rel="manifest" href="site.webmanifest" />
    <meta charset="UTF-8">
    <title>Biometric ID Scanner</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3"></script>
    <style>
        :root { --neon: #00ffcc; --bg: #050505; }
        body { background: var(--bg); color: var(--neon); font-family: 'Inter', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; }
        
        /* --- SCANNER CONTAINER --- */
        /* This keeps the video strictly inside the circle */
        #scanner-ring { 
            position: relative; 
            width: 380px; height: 380px; 
            border-radius: 50%; 
            border: 4px solid #111;
            box-shadow: 0 0 50px rgba(0, 255, 204, 0.2);
            /* This is the magic fix: clips everything to circle */
            overflow: hidden; 
            z-index: 10;
        }

        /* The video element inside the ring */
        video { 
            width: 100%; height: 100%; 
            object-fit: cover; 
            transform: scaleX(-1); /* Mirror effect */
        }

        /* The drawing canvas on top of the video */
        canvas { 
            position: absolute; top: 0; left: 0; 
            width: 100%; height: 100%; 
            transform: scaleX(-1); 
            pointer-events: none;
        }

        /* --- UI TEXT --- */
        .hud-container {
            position: absolute; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            pointer-events: none;
            z-index: 20;
        }

        #status-text {
            margin-top: 420px; /* Pushes it below the ring */
            font-family: monospace; letter-spacing: 4px; font-weight: bold;
            text-shadow: 0 0 10px var(--neon);
        }

        /* --- RESULT / SNAPSHOT UI (Hidden at start) --- */
        #result-ui {
            display: none;
            flex-direction: column; align-items: center; justify-content: center;
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 30;
            pointer-events: auto;
        }

        #retry-btn {
            color: #fff; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 3px;
            cursor: pointer; opacity: 0.6; margin-bottom: 10px; transition: 0.3s;
        }
        #retry-btn:hover { opacity: 1; text-shadow: 0 0 10px #fff; }

        #verified-age {
            font-size: 5rem; font-weight: 900; color: #fff; 
            text-shadow: 0 0 20px var(--neon); margin-bottom: 20px;
        }

        /* The Button that shows the live camera */
        #snap-btn {
            width: 200px; height: 200px;
            border-radius: 50%;
            border: 5px solid #fff;
            box-shadow: 0 0 40px var(--neon);
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
        }
        #snap-btn:hover { transform: scale(1.05); border-color: var(--neon); }
        
        #snap-video-feed {
            width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1);
        }

        #snap-hint {
            position: absolute; bottom: 20px; width: 100%; text-align: center;
            color: #fff; font-weight: bold; font-size: 0.8rem; letter-spacing: 1px;
            text-shadow: 0 2px 2px #000; pointer-events: none;
        }

        /* --- DOWNLOAD CARD OVERLAY --- */
        #card-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100;
            flex-direction: column; align-items: center; justify-content: center;
        }
        #generated-card { border: 2px solid var(--neon); box-shadow: 0 0 60px rgba(0,255,204,0.2); max-height: 80vh; }

    </style>
</head>
<body>

    <div id="scanner-ring">
        <video id="webcam" autoplay playsinline></video>
        <canvas id="overlay"></canvas>
    </div>
    
    <div class="hud-container">
        <div id="status-text">INITIALIZING...</div>
    </div>

    <div id="result-ui">
        <div id="retry-btn" onclick="location.reload()">â†º RETRY SCAN</div>
        <div id="verified-age">--</div>
        
        <div id="snap-btn" title="Click to Capture ID">
            <video id="snap-video-feed" autoplay playsinline></video>
            <div id="snap-hint">TAP TO CAPTURE</div>
        </div>
    </div>

    <div id="card-overlay">
        <img id="generated-card">
        <div style="margin-top:20px; color:#666; font-size:12px; letter-spacing:2px">CLICK IMAGE TO SAVE (CLICK OFF TO DISMISS)</div>
    </div>

    <script type="module">
        import { FaceLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3";

        const video = document.getElementById('webcam');
        const snapVideo = document.getElementById('snap-video-feed');
        const canvas = document.getElementById('overlay');
        const ctx = canvas.getContext('2d');
        const statusText = document.getElementById('status-text');
        const scannerRing = document.getElementById('scanner-ring');
        
        const resultUi = document.getElementById('result-ui');
        const ageDisplay = document.getElementById('verified-age');
        const snapBtn = document.getElementById('snap-btn');
        
        const cardOverlay = document.getElementById('card-overlay');
        const generatedCard = document.getElementById('generated-card');

        let landmarker;
        let running = true;
        let progress = 0;
        let orbit = 0;
        let samples = [];

        async function init() {
            const resolver = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
            landmarker = await FaceLandmarker.createFromOptions(resolver, {
                baseOptions: {
                    modelAssetPath: "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task",
                    delegate: "GPU"
                },
                outputFaceBlendshapes: true,
                runningMode: "VIDEO",
                numFaces: 1
            });

            // Get Webcam Stream
            const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 640 } });
            
            // Feed it to BOTH video elements (Scanner & Snap Button)
            video.srcObject = stream;
            snapVideo.srcObject = stream;

            video.onloadeddata = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                requestAnimationFrame(render);
            };
        }

        function render() {
            if(!running) return; // Stop rendering scan lines if finished

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const results = landmarker.detectForVideo(video, performance.now());

            // 1. GHOST MESH (Always visible in scanner)
            if (results.faceLandmarks && results.faceLandmarks.length > 0) {
                const f = results.faceLandmarks[0];
                
                // Draw Mesh
                ctx.strokeStyle = "rgba(0, 255, 204, 0.3)";
                ctx.lineWidth = 0.5;
                for (let i = 0; i < f.length; i += 8) {
                    const p = f[i];
                    ctx.beginPath();
                    ctx.arc(p.x * canvas.width, p.y * canvas.height, 1, 0, Math.PI * 2);
                    ctx.stroke();
                }

                // 2. ORBIT TARGET LOGIC
                const cx = canvas.width / 2;
                const cy = canvas.height / 2;
                const r = 130;

                orbit += 0.04; 
                const tx = cx + Math.cos(orbit) * r;
                const ty = cy + Math.sin(orbit) * r;

                // Cyan Target Dot
                ctx.fillStyle = "#00ffcc";
                ctx.shadowBlur = 15; ctx.shadowColor = "#00ffcc";
                ctx.beginPath(); ctx.arc(tx, ty, 10, 0, Math.PI * 2); ctx.fill();
                ctx.shadowBlur = 0;

                // Nose Dot
                const nx = f[1].x * canvas.width;
                const ny = f[1].y * canvas.height;

                // White Ring on Nose
                ctx.strokeStyle = "#fff"; ctx.lineWidth = 2;
                ctx.beginPath(); ctx.arc(nx, ny, 15, 0, Math.PI * 2); ctx.stroke();
                
                // Line connecting nose to target
                ctx.strokeStyle = "rgba(0, 255, 204, 0.5)"; ctx.lineWidth = 1;
                ctx.beginPath(); ctx.moveTo(nx, ny); ctx.lineTo(tx, ty); ctx.stroke();

                if (Math.hypot(nx - tx, ny - ty) < 55) {
                    progress += 0.7;
                    statusText.innerText = `SCANNING... ${Math.round(progress)}%`;
                    
                    // Math (+7 offset for "2 years older")
                    const d = (p1, p2) => Math.hypot(p1.x - p2.x, p1.y - p2.y, p1.z - p2.z);
                    const ratioA = d(f[33], f[263]) / d(f[10], f[152]);
                    const ratioB = d(f[234], f[454]) / d(f[10], f[152]);
                    let est = ((0.63 - ratioA) * 60) + ((0.85 - ratioB) * 60) + 7;
                    samples.push(Math.round(est));
                } else {
                    statusText.innerText = "FOLLOW THE ORBIT";
                }

                if (progress >= 100) {
                    completeScan();
                }
            }
            requestAnimationFrame(render);
        }

        function completeScan() {
            running = false;
            samples.sort((a,b) => a-b);
            const age = samples[Math.floor(samples.length / 2)] || 25;
            
            // Hide Scanner
            scannerRing.style.display = "none";
            statusText.style.display = "none";
            
            // Show Result
            resultUi.style.display = "flex";
            ageDisplay.innerText = age;
        }

        // --- SNAPSHOT & DOWNLOAD LOGIC ---
        snapBtn.onclick = () => {
            const card = document.createElement('canvas');
            card.width = 600; card.height = 800;
            const c = card.getContext('2d');

            // 1. Draw Card Background
            c.fillStyle = "#000"; c.fillRect(0,0,600,800);
            
            // 2. Draw the Clean Photo (from video feed)
            c.save();
            c.translate(600, 50); c.scale(-1, 1);
            // Center crop logic
            const sSize = Math.min(video.videoWidth, video.videoHeight);
            const sx = (video.videoWidth - sSize) / 2;
            const sy = (video.videoHeight - sSize) / 2;
            c.drawImage(video, sx, sy, sSize, sSize, 100, 0, 400, 400);
            c.restore();

            // 3. Draw ID Frame
            c.strokeStyle = "#00ffcc"; c.lineWidth = 12; c.strokeRect(0,0,600,800);
            
            c.fillStyle = "#fff"; c.font = "bold 40px Inter, sans-serif";
            c.fillText("BIOMETRIC ID", 50, 500);
            
            c.fillStyle = "#00ffcc"; c.font = "20px Inter, sans-serif";
            c.fillText("VERIFIED AGE", 50, 560);
            
            c.fillStyle = "#fff"; c.font = "bold 100px Inter, sans-serif";
            c.fillText(ageDisplay.innerText, 50, 660);
            
            c.font = "14px monospace"; c.fillStyle = "#666";
            c.fillText(`ID: ${Math.random().toString(36).substring(2, 14).toUpperCase()}`, 50, 750);

            generatedCard.src = card.toDataURL();
            cardOverlay.style.display = "flex";
        };

        generatedCard.onclick = () => {
            const link = document.createElement('a');
            link.download = 'My_Biometric_ID.png';
            link.href = generatedCard.src;
            link.click();
        };

        // Close overlay if clicking background
        cardOverlay.onclick = (e) => {
            if(e.target === cardOverlay) cardOverlay.style.display = "none";
        };

        init();
    </script>
</body>
</html>
