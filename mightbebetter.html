<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="favicon.svg" />
<link rel="shortcut icon" href="favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png" />
<link rel="manifest" href="site.webmanifest" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BioScan AI | StarlightGG</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3"></script>
    <style>
        :root {
            --primary: #00f3ff;
            --secondary: #ff0055;
            --bg: #030508;
            --glass: rgba(0, 243, 255, 0.05);
        }
        
        body { 
            background: var(--bg); 
            color: var(--primary); 
            font-family: 'Courier New', Courier, monospace;
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center; 
            height: 100vh; margin: 0; overflow: hidden; 
        }

        /* --- SCANNER CONTAINER --- */
        #scanner-viewport {
            position: relative;
            width: 100vw; height: 100vh;
            overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }

        video {
            position: absolute;
            width: 100%; height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* Mirror effect */
            filter: grayscale(30%) contrast(1.2) brightness(0.8);
            pointer-events: none; /* Prevents interaction */
        }
        
        /* Hides mobile play buttons */
        video::-webkit-media-controls { display: none !important; }
        video::-webkit-media-controls-start-playback-button { display: none !important; }
        video::-webkit-media-controls-play-button { display: none !important; }
        video::-webkit-media-controls-overlay-play-button { display: none !important; }

        canvas {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            transform: scaleX(-1);
            pointer-events: none;
        }

        /* --- HUD OVERLAY --- */
        .hud-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 10;
            display: flex; flex-direction: column; justify-content: space-between;
        }

        /* Top Bar */
        .hud-top {
            display: flex; justify-content: space-between; padding: 20px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
        }
        .hud-badge {
            border: 1px solid var(--primary);
            padding: 5px 10px; font-size: 12px; letter-spacing: 2px;
            background: var(--glass);
        }

        /* Center Ring/Brackets */
        #scan-guide {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 280px; height: 350px;
            border: 2px solid rgba(0, 243, 255, 0.3);
            border-radius: 20px;
            transition: all 0.3s ease;
        }
        
        #scan-guide::before, #scan-guide::after {
            content: ''; position: absolute; width: 20px; height: 20px;
            border-color: var(--primary); border-style: solid;
            transition: all 0.3s;
        }
        /* Top Left Corner */
        #scan-guide::before { top: -2px; left: -2px; border-width: 4px 0 0 4px; }
        /* Bottom Right Corner */
        #scan-guide::after { bottom: -2px; right: -2px; border-width: 0 4px 4px 0; }

        /* Scanning Laser */
        #scan-laser {
            position: absolute; top: 0; left: -10%; width: 120%; height: 2px;
            background: var(--primary);
            box-shadow: 0 0 20px var(--primary);
            opacity: 0;
            animation: scanMove 2s infinite ease-in-out;
        }

        @keyframes scanMove {
            0% { top: 0%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        /* Data Stream */
        #data-stream {
            position: absolute; bottom: 150px; left: 20px;
            font-size: 10px; line-height: 1.4;
            color: rgba(0, 243, 255, 0.7);
            text-align: left;
            width: 200px;
            height: 100px;
            overflow: hidden;
            mask-image: linear-gradient(to bottom, transparent, black 20%);
        }

        /* Progress Bar */
        #progress-container {
            position: absolute; bottom: 80px; left: 50%; 
            transform: translateX(-50%);
            width: 80%; max-width: 400px;
        }
        #progress-label {
            text-align: center; margin-bottom: 8px; font-size: 14px; letter-spacing: 4px; font-weight: bold;
            text-shadow: 0 0 10px var(--primary);
        }
        #progress-bg {
            width: 100%; height: 6px; background: rgba(255,255,255,0.1);
            border-radius: 3px; overflow: hidden;
        }
        #progress-fill {
            width: 0%; height: 100%; background: var(--primary);
            box-shadow: 0 0 20px var(--primary);
            transition: width 0.1s linear;
        }

        /* --- RESULT SCREEN --- */
        #result-screen {
            display: none;
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(3, 5, 8, 0.95);
            z-index: 50;
            flex-direction: column; align-items: center; justify-content: center;
        }

        .result-box {
            border: 1px solid var(--primary);
            padding: 40px;
            text-align: center;
            background: linear-gradient(135deg, rgba(0,243,255,0.1), transparent);
            box-shadow: 0 0 50px rgba(0,243,255,0.1);
            position: relative;
            min-width: 300px;
        }
        
        .result-box::before {
            content: "IDENTITY VERIFIED";
            position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
            background: var(--bg); padding: 0 10px; color: var(--primary);
            font-size: 12px; letter-spacing: 3px;
        }

        #preview-snapshot {
            width: 120px; height: 120px;
            border-radius: 50%;
            border: 3px solid var(--primary);
            margin: 0 auto 20px auto;
            object-fit: cover;
            display: block;
            box-shadow: 0 0 20px rgba(0,243,255,0.3);
            transform: scaleX(-1);
        }

        #age-result {
            font-size: 6rem; margin: 0; line-height: 1;
            color: #fff; text-shadow: 0 0 40px var(--primary);
            font-weight: 900; font-family: sans-serif;
        }
        
        #age-label {
            font-size: 1.2rem; color: rgba(255,255,255,0.6); letter-spacing: 5px; margin-bottom: 30px;
        }

        #ai-notes {
            color: var(--primary); font-size: 0.8rem; max-width: 300px;
            text-align: left; margin-top: 10px; opacity: 0.8;
            border-top: 1px solid rgba(0,243,255,0.3); padding-top: 10px;
            display: none;
        }

        #confidence-display {
             margin-top: 20px; font-size: 12px; opacity: 0.7;
        }

        .btn {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 15px 40px;
            font-family: inherit; font-size: 16px; letter-spacing: 2px;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.2s;
        }
        .btn:hover { background: var(--primary); color: #000; box-shadow: 0 0 30px var(--primary); }

        .scan-line-decoration {
            width: 100%; height: 1px; background: rgba(255,255,255,0.1);
            margin: 5px 0;
        }

        /* --- ID CARD PREVIEW --- */
        #id-card-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 100;
            flex-direction: column; align-items: center; justify-content: center;
        }
        #id-card-img {
            max-width: 90%; max-height: 80vh; border: 2px solid var(--primary);
            box-shadow: 0 0 50px rgba(0,243,255,0.2);
            cursor: pointer;
        }

    </style>
</head>
<body>

    <div id="scanner-viewport">
        <video id="webcam" autoplay muted playsinline disablePictureInPicture></video>
        <canvas id="overlay"></canvas>
        
        <!-- HUD ELEMENTS -->
        <div class="hud-layer">
            <div class="hud-top">
                <div class="hud-badge" id="sys-status">OFFLINE</div>
                <div class="hud-badge" id="fps-counter">0 FPS</div>
            </div>

            <!-- Targeting Reticle -->
            <div id="scan-guide">
                <div id="scan-laser"></div>
            </div>

            <!-- Scrolling Data -->
            <div id="data-stream">Initializing Core...</div>

            <!-- Progress Bar -->
            <div id="progress-container">
                <div id="progress-label">SEARCHING...</div>
                <div id="progress-bg"><div id="progress-fill"></div></div>
            </div>
        </div>
    </div>

    <!-- RESULTS SCREEN -->
    <div id="result-screen">
        <div class="result-box">
            <img id="preview-snapshot" src="">
            <div id="age-result">--</div>
            <div id="age-label">YEARS DETECTED</div>
            <div class="scan-line-decoration"></div>
            <div id="ai-notes"></div>
            <div class="scan-line-decoration"></div>
            <div id="confidence-display">CONFIDENCE: CALCULATING...</div>
        </div>

        <button id="gen-btn" class="btn" onclick="generateID()">GENERATE ID CARD</button>
        <button class="btn" style="border-color: #555; color: #777; margin-top:10px" onclick="resetSystem()">RESET SYSTEM</button>
    </div>

    <!-- ID CARD MODAL -->
    <div id="id-card-modal">
        <img id="id-card-img">
        <div style="margin-top:20px; color:var(--primary); font-size:12px; letter-spacing:2px">TAP CARD TO DOWNLOAD</div>
    </div>

    <script type="module">
        import { FaceLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3";

        // --- CONFIGURATION ---
        const KEY_URL = "https://starlightgg.github.io/txt/token.txt"; // <--- PUT YOUR TXT FILE URL HERE
        // ---------------------

        const video = document.getElementById('webcam');
        const canvas = document.getElementById('overlay');
        const ctx = canvas.getContext('2d');
        const progressFill = document.getElementById('progress-fill');
        const progressLabel = document.getElementById('progress-label');
        const dataStream = document.getElementById('data-stream');
        const scanGuide = document.getElementById('scan-guide');
        const scanLaser = document.getElementById('scan-laser');
        const resultScreen = document.getElementById('result-screen');
        const ageResult = document.getElementById('age-result');
        const fpsCounter = document.getElementById('fps-counter');
        const sysStatus = document.getElementById('sys-status');
        const aiNotes = document.getElementById('ai-notes');
        const confidenceDisplay = document.getElementById('confidence-display');
        const previewSnapshot = document.getElementById('preview-snapshot');
        const idCardModal = document.getElementById('id-card-modal');
        const genBtn = document.getElementById('gen-btn');

        let landmarker;
        let running = true;
        let scanProgress = 0;
        let lastTime = 0;
        let apiKey = null;
        let capturedImageBase64 = null; // Store image for consistent ID card

        const bioData = [
            "MEASURING CRANIAL GEOMETRY...",
            "ANALYZING SKIN TEXTURE...",
            "CALCULATING INTER-PUPILLARY DISTANCE...",
            "CHECKING BONE STRUCTURE...",
            "ESTIMATING CELLULAR DECAY...",
        ];

        function addLog(text) {
            dataStream.innerHTML += `<br>> ${text}`;
            dataStream.scrollTop = dataStream.scrollHeight;
        }

        async function fetchApiKey() {
            try {
                if (KEY_URL.includes("your-website.com")) {
                    addLog("WARN: KEY URL NOT CONFIGURED");
                    return;
                }
                addLog("CONNECTING TO SECURE SERVER...");
                const response = await fetch(KEY_URL);
                if(!response.ok) throw new Error("Key fetch failed");
                const text = await response.text();
                // Decode and format as requested
                const decoded = atob(text.trim());
                apiKey = "gsk_" + decoded;
                addLog("SECURE CONNECTION ESTABLISHED.");
                sysStatus.innerText = "ONLINE [AI]";
                sysStatus.style.background = "rgba(0, 243, 255, 0.2)";
            } catch (e) {
                addLog("OFFLINE MODE ACTIVATED.");
                console.warn("API Key Error:", e);
                sysStatus.innerText = "OFFLINE [SIM]";
            }
        }

        async function init() {
            addLog("LOADING VISION MODELS...");
            await fetchApiKey();
            
            const resolver = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
            landmarker = await FaceLandmarker.createFromOptions(resolver, {
                baseOptions: {
                    modelAssetPath: "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task",
                    delegate: "GPU"
                },
                runningMode: "VIDEO",
                numFaces: 1
            });

            addLog("ACCESSING OPTICAL SENSORS...");
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user", width: { ideal: 1280 }, height: { ideal: 720 } } 
                });
                video.srcObject = stream;
                video.onloadeddata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    requestAnimationFrame(loop);
                };
            } catch (err) {
                addLog("ERROR: CAMERA ACCESS DENIED");
                alert("Camera access needed for scan.");
            }
        }

        function loop(time) {
            if(!running) return;
            const delta = time - lastTime;
            lastTime = time;
            if(Math.random() > 0.9) fpsCounter.innerText = Math.round(1000/delta) + " FPS";

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (landmarker) {
                const results = landmarker.detectForVideo(video, time);
                if (results.faceLandmarks && results.faceLandmarks.length > 0) {
                    const face = results.faceLandmarks[0];
                    drawFace(face);
                    handleScanLogic(true, face);
                } else {
                    handleScanLogic(false, null);
                }
            }
            requestAnimationFrame(loop);
        }

        function handleScanLogic(faceDetected, landmarks) {
            if (faceDetected && landmarks) {
                // Calculate geometry
                const ys = landmarks.map(l => l.y);
                const xs = landmarks.map(l => l.x);
                const minY = Math.min(...ys);
                const maxY = Math.max(...ys);
                const minX = Math.min(...xs);
                const maxX = Math.max(...xs);

                const faceHeight = maxY - minY; 
                const faceCenterX = (minX + maxX) / 2;

                // Thresholds
                const MIN_HEIGHT = 0.25; 
                const MAX_HEIGHT = 0.75; 
                const CENTER_TOLERANCE = 0.1; 

                let statusMsg = "";
                let isPositionValid = true;

                if (faceHeight < MIN_HEIGHT) {
                    statusMsg = "MOVE CLOSER";
                    isPositionValid = false;
                } else if (faceHeight > MAX_HEIGHT) {
                    statusMsg = "MOVE BACK";
                    isPositionValid = false;
                } else if (Math.abs(faceCenterX - 0.5) > CENTER_TOLERANCE) {
                    statusMsg = "CENTER FACE";
                    isPositionValid = false;
                }

                if (isPositionValid) {
                    scanGuide.style.borderColor = "var(--primary)";
                    scanGuide.style.boxShadow = "0 0 30px rgba(0, 243, 255, 0.2)";
                    scanLaser.style.opacity = "1";
                    scanLaser.style.background = "var(--primary)";
                    
                    scanProgress += 0.5; 
                    
                    if(Math.floor(scanProgress) % 25 === 0 && Math.random() > 0.5) {
                        addLog(bioData[Math.floor(Math.random() * bioData.length)]);
                    }

                    progressLabel.innerText = `SCANNING: ${Math.min(100, Math.floor(scanProgress))}%`;
                    
                    if (scanProgress >= 100) {
                        startAnalysis(); 
                    }
                } else {
                    scanGuide.style.borderColor = "var(--secondary)";
                    scanGuide.style.boxShadow = "0 0 30px rgba(255, 0, 85, 0.3)";
                    scanLaser.style.opacity = "1"; 
                    scanLaser.style.background = "var(--secondary)";
                    
                    progressLabel.innerText = statusMsg;
                }
            } else {
                scanProgress = Math.max(0, scanProgress - 2);
                scanGuide.style.borderColor = "rgba(255, 255, 255, 0.2)";
                scanGuide.style.boxShadow = "none";
                scanLaser.style.opacity = "0";
                progressLabel.innerText = "ALIGN FACE IN FRAME";
            }
            progressFill.style.width = `${scanProgress}%`;
        }

        function drawFace(landmarks) {
            ctx.fillStyle = "rgba(0, 243, 255, 0.6)";
            ctx.strokeStyle = "rgba(0, 243, 255, 0.3)";
            ctx.lineWidth = 1;
            const get = (i) => ({x: landmarks[i].x * canvas.width, y: landmarks[i].y * canvas.height});

            const keyPoints = [10, 152, 234, 454, 1, 4, 168, 33, 263, 61, 291];
            
            ctx.beginPath();
            const nose = get(1);
            const leftEye = get(33);
            const rightEye = get(263);
            ctx.moveTo(nose.x, nose.y); ctx.lineTo(leftEye.x, leftEye.y);
            ctx.moveTo(nose.x, nose.y); ctx.lineTo(rightEye.x, rightEye.y);
            ctx.lineTo(leftEye.x, leftEye.y);
            ctx.stroke();

            keyPoints.forEach(id => {
                const p = get(id);
                ctx.beginPath(); ctx.arc(p.x, p.y, 2, 0, 2 * Math.PI); ctx.fill();
            });

            const xs = landmarks.map(l => l.x); const ys = landmarks.map(l => l.y);
            const minX = Math.min(...xs) * canvas.width; const maxX = Math.max(...xs) * canvas.width;
            const minY = Math.min(...ys) * canvas.height; const maxY = Math.max(...ys) * canvas.height;
            const pad = 20;
            
            ctx.strokeStyle = "#fff"; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.moveTo(minX - pad, minY - pad + 20); 
            ctx.lineTo(minX - pad, minY - pad); ctx.lineTo(minX - pad + 20, minY - pad); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(maxX + pad, maxY + pad - 20); 
            ctx.lineTo(maxX + pad, maxY + pad); ctx.lineTo(maxX + pad - 20, maxY + pad); ctx.stroke();
        }

        async function startAnalysis() {
            running = false;
            progressLabel.innerText = "UPLOADING TO NEURAL NET...";
            addLog("SENDING ENCRYPTED PACKET...");
            
            // Capture image for AI & Preview
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = video.videoWidth; tempCanvas.height = video.videoHeight;
            const tCtx = tempCanvas.getContext('2d');
            tCtx.drawImage(video, 0, 0);
            
            // Save global captured image
            capturedImageBase64 = tempCanvas.toDataURL('image/jpeg', 0.8);
            
            // Set preview image in result screen
            previewSnapshot.src = capturedImageBase64;

            if (!apiKey) {
                // Fallback Simulation
                setTimeout(() => {
                    const age = 12 + Math.floor(Math.random() * 3);
                    displayResult(age, "SIMULATION MODE: KEY NOT FOUND", 99.9);
                }, 1500);
                return;
            }

            try {
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${apiKey}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        model: "meta-llama/llama-4-scout-17b-16e-instruct",
                        messages: [
                            {
                                role: "user",
                                content: [
                                    { type: "text", text: `Analyze the face in this image with clinical precision. Return a JSON object with keys: 
                                    - 'age' (integer - single estimated year), 
                                    - 'gender' (string), 
                                    - 'features' (short string describing distinctive features),
                                    - 'confidence' (number between 0 and 100 based on image clarity).
                                    
                                    Do not include markdown formatting. 
                                    
                                    CRITICAL AGE ESTIMATION RULES:
                                    1. Prioritize skeletal structure (jawline, cheekbones) over temporary facial expressions.
                                    2. IGNORE "funny faces", scrunching, grimacing, or puffing cheeks. Do not let these distortions make the subject appear like a toddler (9yo) or baby. Look at the eye-to-chin ratio.
                                    3. For younger subjects (10-18), look for neotenous traits but be precise.
                                    4. If the face is distorted by expression, lower the confidence score.
                                    5. Ignore lighting shadows.` },
                                    { type: "image_url", image_url: { url: capturedImageBase64 } }
                                ]
                            }
                        ],
                        max_tokens: 250
                    })
                });

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message);
                }

                const content = data.choices[0].message.content;
                addLog("PACKET RECEIVED. DECODING...");
                
                let result = { age: 0, features: "Unknown", confidence: 0 };
                try {
                    const jsonStr = content.replace(/```json/g, '').replace(/```/g, '').trim();
                    result = JSON.parse(jsonStr);
                } catch (e) {
                    const ageMatch = content.match(/"age":\s*(\d+)/);
                    result.age = ageMatch ? parseInt(ageMatch[1]) : 0;
                    result.features = "Analysis complete";
                    result.confidence = 85.5; 
                }

                displayResult(result.age, result.features, result.confidence);

            } catch (err) {
                console.error(err);
                addLog("CONNECTION LOST. REVERTING TO LOCAL CACHE.");
                setTimeout(() => {
                     displayResult(12 + Math.floor(Math.random() * 3), "CONNECTION ERROR - EST. MODE", 0);
                }, 1000);
            }
        }

        function displayResult(age, notes, confidence) {
            if (confidence < 80) {
                // FAILURE STATE
                ageResult.innerText = "FAIL";
                ageResult.style.color = "var(--secondary)";
                document.getElementById('age-label').innerText = "SCAN REJECTED";
                
                aiNotes.style.display = "block";
                aiNotes.innerText = "> ERROR: LOW CONFIDENCE (" + confidence + "%). PLEASE HOLD STILL, KEEP FACE NEUTRAL, AND ENSURE GOOD LIGHTING.";
                aiNotes.style.color = "var(--secondary)";
                
                confidenceDisplay.innerText = "THRESHOLD REQUIRED: 80%";
                confidenceDisplay.style.color = "var(--secondary)";
                
                genBtn.style.display = "none"; // Hide generate button
            } else {
                // SUCCESS STATE
                ageResult.innerText = age;
                ageResult.style.color = "#fff";
                document.getElementById('age-label').innerText = "YEARS DETECTED";
                
                if(notes) {
                    aiNotes.style.display = "block";
                    aiNotes.innerText = "> BIO-NOTES: " + notes.toUpperCase();
                    aiNotes.style.color = "var(--primary)";
                }
                
                confidenceDisplay.innerText = "CONFIDENCE: " + confidence + "%";
                confidenceDisplay.style.color = "var(--primary)";
                
                genBtn.style.display = "inline-block"; // Show generate button
            }
            resultScreen.style.display = 'flex';
        }

        window.generateID = () => {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = 600; tempCanvas.height = 900;
            const tCtx = tempCanvas.getContext('2d');
            tCtx.fillStyle = "#050505"; tCtx.fillRect(0,0,600,900);
            const grad = tCtx.createLinearGradient(0,0,600,0);
            grad.addColorStop(0, '#00f3ff'); grad.addColorStop(1, '#0066ff');
            tCtx.fillStyle = grad; tCtx.fillRect(0,0,600,10);

            // Use the image we captured during scanning (to match preview)
            const photoImg = new Image();
            photoImg.src = capturedImageBase64 || ""; // Fallback if empty
            
            photoImg.onload = () => {
                tCtx.save();
                tCtx.translate(600, 0); tCtx.scale(-1, 1); 
                
                const vidSize = Math.min(photoImg.width, photoImg.height);
                const sx = (photoImg.width - vidSize) / 2;
                const sy = (photoImg.height - vidSize) / 2;
                
                // Draw at x=100 (in local space) to appear at x=100 (in screen space)
                // Logic: 600 - 100 - 400 = 100.
                tCtx.drawImage(photoImg, sx, sy, vidSize, vidSize, 100, 150, 400, 400); 
                tCtx.restore();

                tCtx.strokeStyle = "#00f3ff"; tCtx.lineWidth = 4;
                tCtx.strokeRect(100, 150, 400, 400);
                
                tCtx.fillStyle = "#fff"; tCtx.textAlign = "center";
                tCtx.font = "bold 40px Courier New"; tCtx.fillText("OFFICIAL ID", 300, 100);
                tCtx.font = "20px Courier New"; tCtx.fillStyle = "#aaa"; tCtx.fillText("ISSUED BY AI BIO-SCAN", 300, 600);
                tCtx.font = "bold 120px Courier New"; tCtx.fillStyle = "#00f3ff"; tCtx.fillText(ageResult.innerText, 300, 750);
                tCtx.font = "20px Courier New"; tCtx.fillStyle = "#fff"; tCtx.fillText("YEARS OLD", 300, 800);
                tCtx.fillStyle = "#333"; tCtx.fillRect(100, 840, 400, 20);

                const img = document.getElementById('id-card-img');
                img.src = tempCanvas.toDataURL("image/jpeg");
                idCardModal.style.display = 'flex';
            };
        };

        // Modal Click Handling
        idCardModal.onclick = (e) => {
            // Close if clicking background
            if (e.target === idCardModal) {
                idCardModal.style.display = 'none';
            }
        };

        // Download on Image Click
        document.getElementById('id-card-img').onclick = () => {
             const link = document.createElement('a');
             link.download = `BioScan_ID_${ageResult.innerText}.jpg`;
             link.href = document.getElementById('id-card-img').src;
             link.click();
        };

        window.resetSystem = () => {
            resultScreen.style.display = 'none';
            scanProgress = 0;
            running = true;
            progressFill.style.width = '0%';
            progressLabel.innerText = "SEARCHING...";
            dataStream.innerHTML = "SYSTEM RESET...<br>RE-ACQUIRING TARGET...";
            requestAnimationFrame(loop);
        }

        init();
    </script>
</body>
</html>
